-- LcL Tools - åŒæ­¥å¯¼å‡ºæ ¸å¿ƒåŠŸèƒ½
-- åŸºäºSyncBlenderæ”¹å†™ï¼Œä¸“é—¨å¤„ç†Maxåˆ°Blenderçš„å¯¼å‡º

-- å…¨å±€å˜é‡ - ä½¿ç”¨ç³»ç»Ÿä¸´æ—¶ç›®å½•
global LcL_TempDir = (sysInfo.tempdir + "LcL_Tools_Exchange\\")

-- å¯¼å‡ºè®¾ç½®ç»“æ„
struct LcL_SyncConfig
(
    tempDir = LcL_TempDir,
    exportFile = LcL_TempDir + "export_model.fbx",
    includeAnimation = true,  
    openFolderAfter = true
)

-- å…¨å±€é…ç½®å®ä¾‹
global lclSyncConfig = LcL_SyncConfig()

-- è®¾ç½®FBXå¯¼å‡ºå‚æ•°
fn LcL_SetupFBXExport = 
(
    -- è·å–ç”¨æˆ·è®¾ç½®ï¼Œå¦‚æœæœªå®šä¹‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
    local exportSettings = LcL_ExportSettings
    if exportSettings == undefined then
    (
        format "âš  å¯¼å‡ºè®¾ç½®æœªåŠ è½½ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®\n"
        -- å¦‚æœç»“æ„æœªå®šä¹‰ï¼Œåˆ›å»ºä¸´æ—¶ç»“æ„
        if LcL_ExportConfig == undefined then
        (
            struct TempExportConfig
            (
                includeAnimation = true,
                fileFormat = "Binary",
                convertUnit = "cm",
                upAxis = "Y",
                bakeAnimation = true
            )
            exportSettings = TempExportConfig()
        )
        else
        (
            exportSettings = LcL_ExportConfig()
            exportSettings.includeAnimation = true
            exportSettings.fileFormat = "Binary"
            exportSettings.convertUnit = "cm"
            exportSettings.upAxis = "Y"
            exportSettings.bakeAnimation = true
        )
    )
    
    -- è®¾ç½®åŠ¨ç”»ç›¸å…³å‚æ•°
    FBXExporterSetParam "Animation" exportSettings.includeAnimation
    FBXExporterSetParam "BakeAnimation" exportSettings.bakeAnimation
    if exportSettings.includeAnimation then
    (
        FBXExporterSetParam "BakeFrameStart" animationRange.start.frame
        FBXExporterSetParam "BakeFrameEnd" animationRange.end.frame
    )
    
    -- ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„å•ä½å’Œè½´å‘ï¼ˆè½¬æ¢ä¸ºç¬¦å·æ ¼å¼ï¼‰
    local unitSymbol = if exportSettings.convertUnit == "cm" then #cm else #m
    local axisSymbol = if exportSettings.upAxis == "Y" then #Y else #Z
    local formatSymbol = if exportSettings.fileFormat == "Binary" then #binary else #ascii
    
    FBXExporterSetParam "ConvertUnit" unitSymbol
    FBXExporterSetParam "UpAxis" axisSymbol
    FBXExporterSetParam "FileFormat" formatSymbol
    FBXExporterSetParam "ASCIIFormat" "6.0"
    
    -- å…³é”®è®¾ç½®ï¼šåªå¯¼å‡ºå¯è§å¯¹è±¡
    FBXExporterSetParam "FilterKeyReducer" false
    FBXExporterSetParam "NormalsPerVertex" true
    FBXExporterSetParam "TangentSpaceExport" true
    
    -- å°è¯•è®¾ç½®åªå¯¼å‡ºå¯è§å¯¹è±¡
    try (FBXExporterSetParam "ExportHiddenObjects" false) catch()
    try (FBXExporterSetParam "IncludeHidden" false) catch()
    
    return true
)

-- åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹
fn LcL_CreateTempDir = 
(
    makeDir lclSyncConfig.tempDir
    return true
)

-- æ ¸å¿ƒå¯¼å‡ºå‡½æ•°
fn LcL_ExportFBX = 
(
    -- åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹
    LcL_CreateTempDir()
    
    -- è®¾ç½®FBXå‚æ•°
    LcL_SetupFBXExport()
    
    -- ç¡®ä¿è¿‡æ»¤å‡½æ•°å’Œè®¾ç½®å­˜åœ¨
    if LcL_ShouldFilterObject == undefined then
    (
        format "âš  è¿‡æ»¤å‡½æ•°æœªåŠ è½½ï¼Œå°è¯•åŠ è½½è®¾ç½®æ–‡ä»¶...\n"
        -- å°è¯•åŠ è½½è®¾ç½®æ–‡ä»¶
        pluginPath = getFilenamePath (getThisScriptFilename())
        -- è·å–ä¸Šä¸¤çº§ç›®å½•åˆ°ui
        parentDir = getFilenamePath (substring pluginPath 1 (pluginPath.count - 1))
        parentDir = getFilenamePath (substring parentDir 1 (parentDir.count - 1))
        settingsFile = parentDir + "ui\\SettingsUI.ms"
        if doesFileExist settingsFile then
            fileIn settingsFile
        
        -- å¦‚æœä»ç„¶æœªå®šä¹‰ï¼Œåˆ›å»ºä¸´æ—¶ç©ºè¿‡æ»¤å‡½æ•°
        if LcL_ShouldFilterObject == undefined then
        (
            format "âš  æ— æ³•åŠ è½½è¿‡æ»¤è®¾ç½®ï¼Œä½¿ç”¨ç©ºè¿‡æ»¤å‡½æ•°\n"
            fn LcL_ShouldFilterObject obj = false
        )
        else
        (
            format "âœ… è¿‡æ»¤å‡½æ•°å·²åŠ è½½\n"
        )
    )
    
    -- åº”ç”¨è¿‡æ»¤è®¾ç½® - åˆ›å»ºéœ€è¦å¯¼å‡ºçš„å¯¹è±¡é€‰æ‹©é›†
    totalObjects = objects.count
    filteredCount = 0
    exportObjects = #()
    
    -- æ”¶é›†éœ€è¦å¯¼å‡ºçš„å¯¹è±¡
    for obj in objects do
    (
        if LcL_ShouldFilterObject obj then
            filteredCount += 1
        else
            append exportObjects obj
    )
    
    exportCount = totalObjects - filteredCount
    format "ğŸš€ å¼€å§‹å¯¼å‡ºå¯¹è±¡åˆ°: %\n" lclSyncConfig.exportFile
    format "ğŸ“Š æ€»å¯¹è±¡: % ä¸ªï¼Œè¿‡æ»¤: % ä¸ªï¼Œå¯¼å‡º: % ä¸ª\n" totalObjects filteredCount exportCount
    
    -- å¤‡ä»½å½“å‰é€‰æ‹©
    oldSelection = selection as array
    
    -- é€‰ä¸­è¦å¯¼å‡ºçš„å¯¹è±¡
    select exportObjects
    
    -- æ‰§è¡Œå¯¼å‡º - åªå¯¼å‡ºé€‰ä¸­å¯¹è±¡
    exportFile lclSyncConfig.exportFile #noPrompt selectedOnly:true
    
    -- æ¢å¤åŸå§‹é€‰æ‹©
    select oldSelection
    
    -- æˆåŠŸæç¤º
    format "âœ… å¯¼å‡ºæˆåŠŸï¼\n"
    format "ğŸ“ æ–‡ä»¶ä½ç½®: %\n" lclSyncConfig.exportFile
    format "ğŸ“Š å®é™…å¯¼å‡º: % ä¸ªå¯¹è±¡\n" exportCount
    
    return true
)

-- å¿«é€Ÿå¯¼å‡ºå‡½æ•°ï¼ˆM2B - Max to Blenderï¼‰
fn LcL_QuickExport = 
(
    result = LcL_ExportFBX()
    
    if result then
    (
        -- æ˜¾ç¤ºç®€æ´çš„æˆåŠŸæç¤º
        messageBox "å·²å‘é€åˆ°Blender" title:"LcL Tools"
    )
    
    return result
)

-- è·å–å¯¼å‡ºä¿¡æ¯
fn LcL_GetExportInfo = 
(
    info = ""
    info += "ä¸´æ—¶æ–‡ä»¶å¤¹: " + lclSyncConfig.tempDir + "\n"
    info += "å¯¼å‡ºæ–‡ä»¶: " + (filenameFromPath lclSyncConfig.exportFile) + "\n"
    
    -- æ ¹æ®è®¾ç½®æ˜¾ç¤ºä¿¡æ¯
    if LcL_ExportSettings != undefined then
    (
        info += "åŒ…å«åŠ¨ç”»: " + (if LcL_ExportSettings.includeAnimation then "æ˜¯" else "å¦") + "\n"
        info += "æ–‡ä»¶æ ¼å¼: " + LcL_ExportSettings.fileFormat + "\n"
        info += "å•ä½è½¬æ¢: " + LcL_ExportSettings.convertUnit + "\n"
        info += "å‘ä¸Šè½´: " + LcL_ExportSettings.upAxis + "\n"
    )
    else
    (
        info += "åŒ…å«åŠ¨ç”»: æ˜¯ï¼ˆé»˜è®¤ï¼‰\n"
        info += "æ–‡ä»¶æ ¼å¼: Binaryï¼ˆé»˜è®¤ï¼‰\n"
        info += "å•ä½è½¬æ¢: cmï¼ˆé»˜è®¤ï¼‰\n"
        info += "å‘ä¸Šè½´: Yï¼ˆé»˜è®¤ï¼‰\n"
    )
    
    info += "å½“å‰é€‰æ‹©: " + selection.count as string + " ä¸ªå¯¹è±¡\n"
    
    return info
)

format "âœ… LcL Tools åŒæ­¥å¯¼å‡ºæ ¸å¿ƒåŠ è½½å®Œæˆ\n"