-- LcL Tools è®¾ç½®ç•Œé¢
-- åŸºäºSyncBlenderæ”¹å†™ï¼Œç”¨äºé…ç½®åŒæ­¥å’Œè¿‡æ»¤è§„åˆ™

-- å…¨å±€è®¾ç½®å˜é‡ï¼Œé»˜è®¤å¡«å……è¿‡æ»¤åˆ—è¡¨
global LcL_FilterSettings = #("Camera", "pickshape")
global LcL_ExportSettings = undefined
global LcL_SettingsDialog = undefined

-- å¯¼å‡ºè®¾ç½®ç»“æ„
struct LcL_ExportConfig
(
    includeAnimation = true,
    fileFormat = "Binary",     -- "Binary" æˆ– "ASCII"
    convertUnit = "cm",        -- "cm" æˆ– "m"
    upAxis = "Y",             -- "Y" æˆ– "Z"
    bakeAnimation = true
)

-- é¢œè‰²è®¾ç½®ç»“æ„
struct LcL_ColorConfig
(
    vertexIndexColor = [255,255,0],    -- é¡¶ç‚¹ç´¢å¼•é¢œè‰²ï¼ˆé»„è‰²ï¼‰
    faceIndexColor = [0,255,255],      -- é¢ç´¢å¼•é¢œè‰²ï¼ˆé’è‰²ï¼‰
    vertexIndexEnabled = false,        -- é¡¶ç‚¹ç´¢å¼•å¼€å…³çŠ¶æ€
    faceIndexEnabled = false           -- é¢ç´¢å¼•å¼€å…³çŠ¶æ€
)

-- å…¨å±€é¢œè‰²è®¾ç½®å˜é‡
global LcL_ColorSettings = undefined

-- åˆå§‹åŒ–é»˜è®¤è®¾ç½®
fn LcL_InitDefaultSettings = 
(
    -- å¼ºåˆ¶åˆå§‹åŒ–è¿‡æ»¤è®¾ç½®ï¼Œç¡®ä¿é»˜è®¤å€¼å­˜åœ¨
    global LcL_FilterSettings = #("Camera", "pickshape")
    format "âœ… åˆå§‹åŒ–é»˜è®¤è¿‡æ»¤è®¾ç½®: %\n" LcL_FilterSettings
    
    -- åˆå§‹åŒ–å¯¼å‡ºè®¾ç½®
    if LcL_ExportSettings == undefined then
    (
        global LcL_ExportSettings = LcL_ExportConfig()
        format "âœ… åˆå§‹åŒ–é»˜è®¤å¯¼å‡ºè®¾ç½®\n"
    )
    
    -- åˆå§‹åŒ–é¢œè‰²è®¾ç½®
    if LcL_ColorSettings == undefined then
    (
        global LcL_ColorSettings = LcL_ColorConfig()
        -- åŒæ­¥åˆ°ç´¢å¼•æ˜¾ç¤ºæ¨¡å—
        if LcL_VertexIndexColor != undefined then
        (
            global LcL_VertexIndexColor = LcL_ColorSettings.vertexIndexColor
            global LcL_FaceIndexColor = LcL_ColorSettings.faceIndexColor
        )
        format "âœ… åˆå§‹åŒ–é»˜è®¤é¢œè‰²è®¾ç½®\n"
    )
)

-- ä¿å­˜æ‰€æœ‰è®¾ç½®åˆ°æ–‡ä»¶
fn LcL_SaveAllSettings = 
(
    settingsFile = (sysInfo.tempdir + "LcL_Tools_Settings.ini")
    fileOut = createFile settingsFile
    if fileOut != undefined then
    (
        -- ä¿å­˜å¯¼å‡ºè®¾ç½®
        format "# LcL Tools Settings\n" to:fileOut
        format "[Export]\n" to:fileOut
        format "includeAnimation=%\n" LcL_ExportSettings.includeAnimation to:fileOut
        format "fileFormat=%\n" LcL_ExportSettings.fileFormat to:fileOut
        format "convertUnit=%\n" LcL_ExportSettings.convertUnit to:fileOut
        format "upAxis=%\n" LcL_ExportSettings.upAxis to:fileOut
        format "bakeAnimation=%\n" LcL_ExportSettings.bakeAnimation to:fileOut
        
        -- ä¿å­˜è¿‡æ»¤è®¾ç½®
        format "[Filter]\n" to:fileOut
        for filter in LcL_FilterSettings do
        (
            format "filter=%\n" filter to:fileOut
        )
        
        -- ä¿å­˜é¢œè‰²è®¾ç½®
        format "[Colors]\n" to:fileOut
        format "vertexIndexColor=%,%,%\n" LcL_ColorSettings.vertexIndexColor[1] LcL_ColorSettings.vertexIndexColor[2] LcL_ColorSettings.vertexIndexColor[3] to:fileOut
        format "faceIndexColor=%,%,%\n" LcL_ColorSettings.faceIndexColor[1] LcL_ColorSettings.faceIndexColor[2] LcL_ColorSettings.faceIndexColor[3] to:fileOut
        format "vertexIndexEnabled=%\n" LcL_ColorSettings.vertexIndexEnabled to:fileOut
        format "faceIndexEnabled=%\n" LcL_ColorSettings.faceIndexEnabled to:fileOut
        close fileOut
        format "âœ… æ‰€æœ‰è®¾ç½®å·²ä¿å­˜åˆ°: %\n" settingsFile
    )
)

-- åŠ è½½æ‰€æœ‰è®¾ç½®æ–‡ä»¶
fn LcL_LoadAllSettings = 
(
    settingsFile = (sysInfo.tempdir + "LcL_Tools_Settings.ini")
    if doesFileExist settingsFile then
    (
        fileIn = openFile settingsFile
        if fileIn != undefined then
        (
            LcL_FilterSettings = #()
            if LcL_ExportSettings == undefined then
                global LcL_ExportSettings = LcL_ExportConfig()
            if LcL_ColorSettings == undefined then
                global LcL_ColorSettings = LcL_ColorConfig()
            
            currentSection = ""
            while not eof fileIn do
            (
                line = readLine fileIn
                line = trimLeft (trimRight line)
                
                if line != "" and line[1] != "#" then
                (
                    -- æ£€æŸ¥æ˜¯å¦æ˜¯èŠ‚æ ‡é¢˜
                    if line[1] == "[" and line[line.count] == "]" then
                    (
                        currentSection = substring line 2 (line.count - 2)
                    )
                    else
                    (
                        -- è§£æé”®å€¼å¯¹
                        eqPos = findString line "="
                        if eqPos != undefined then
                        (
                            key = trimRight (substring line 1 (eqPos - 1))
                            value = trimLeft (substring line (eqPos + 1) -1)
                            
                            if currentSection == "Export" then
                            (
                                case key of
                                (
                                    "includeAnimation": LcL_ExportSettings.includeAnimation = (value == "true")
                                    "fileFormat": LcL_ExportSettings.fileFormat = value
                                    "convertUnit": LcL_ExportSettings.convertUnit = value
                                    "upAxis": LcL_ExportSettings.upAxis = value
                                    "bakeAnimation": LcL_ExportSettings.bakeAnimation = (value == "true")
                                )
                            )
                            else if currentSection == "Filter" then
                            (
                                if key == "filter" then
                                    append LcL_FilterSettings value
                            )
                            else if currentSection == "Colors" then
                            (
                                case key of
                                (
                                    "vertexIndexColor": (
                                        local colorValues = filterString value ","
                                        if colorValues.count == 3 then
                                            LcL_ColorSettings.vertexIndexColor = [colorValues[1] as integer, colorValues[2] as integer, colorValues[3] as integer]
                                    )
                                    "faceIndexColor": (
                                        local colorValues = filterString value ","
                                        if colorValues.count == 3 then
                                            LcL_ColorSettings.faceIndexColor = [colorValues[1] as integer, colorValues[2] as integer, colorValues[3] as integer]
                                    )
                                    "vertexIndexEnabled": LcL_ColorSettings.vertexIndexEnabled = (value == "true")
                                    "faceIndexEnabled": LcL_ColorSettings.faceIndexEnabled = (value == "true")
                                )
                            )
                        )
                    )
                )
            )
            close fileIn
            format "âœ… è®¾ç½®å·²åŠ è½½: % ä¸ªè¿‡æ»¤è§„åˆ™\n" LcL_FilterSettings.count
        )
    )
    else
    (
        LcL_InitDefaultSettings()
    )
)

-- å…¼å®¹æ€§å‡½æ•°
fn LcL_SaveSettings = LcL_SaveAllSettings
fn LcL_LoadSettings = LcL_LoadAllSettings

-- æ£€æŸ¥å¯¹è±¡æ˜¯å¦åº”è¯¥è¢«è¿‡æ»¤
fn LcL_ShouldFilterObject obj = 
(
    -- ç¡®ä¿å…¨å±€è®¾ç½®å­˜åœ¨
    if LcL_FilterSettings == undefined or LcL_FilterSettings.count == 0 then
        return false
        
    objName = obj.name as string
    for filter in LcL_FilterSettings do
    (
        if matchPattern objName pattern:("*" + filter + "*") ignoreCase:true then
        (
            format "ğŸ” è¿‡æ»¤å¯¹è±¡: % (åŒ¹é…: %)\n" objName filter
            return true
        )
    )
    return false
)

-- ===== ä¼˜åŒ–åçš„è®¾ç½®å¯¹è¯æ¡† =====

rollout LcL_SettingsRollout "LcL Tools è®¾ç½®" width:400 height:350
(
    -- å¯¼å‡ºè®¾ç½®ç»„ï¼ˆç²¾ç®€ç‰ˆï¼‰
    group "FBX å¯¼å‡ºè®¾ç½®"
    (
        checkbox chk_animation "åŒ…å«åŠ¨ç”»æ•°æ®" checked:true width:180
        radioButtons rad_fileFormat "æ ¼å¼:" labels:#("äºŒè¿›åˆ¶", "ASCII") default:1 columns:2
        radioButtons rad_unit "å•ä½:" labels:#("å˜ç±³", "ç±³") default:1 columns:2
        radioButtons rad_upAxis "è½´å‘:" labels:#("Yè½´å‘ä¸Š", "Zè½´å‘ä¸Š") default:1 columns:2
    )
    
    -- è¿‡æ»¤è®¾ç½®ç»„ï¼ˆç®€åŒ–ç‰ˆï¼‰
    group "å¯¹è±¡è¿‡æ»¤ (æŒ‰åç§°å…³é”®è¯)"
    (
        listBox lst_filters height:5 items:#()
        
        editText edt_newFilter "" width:240 across:2 tooltip:"è¾“å…¥è¦è¿‡æ»¤çš„å¯¹è±¡åç§°å…³é”®è¯"
        button btn_addFilter "æ·»åŠ " width:50 tooltip:"æ·»åŠ è¿‡æ»¤å…³é”®è¯"
        
        button btn_removeFilter "åˆ é™¤" width:70 across:3 tooltip:"åˆ é™¤é€‰ä¸­çš„è¿‡æ»¤è¯"
        button btn_clear "æ¸…ç©º" width:70 tooltip:"æ¸…ç©ºæ‰€æœ‰è¿‡æ»¤è¯"
        button btn_reset "é»˜è®¤" width:70 tooltip:"é‡ç½®ä¸ºé»˜è®¤è¿‡æ»¤è®¾ç½®"
    )
    
    -- ä¿¡æ¯å’Œæ“ä½œ
    group ""
    (
        label lbl_status "" width:300 height:20 align:#center
        
        button btn_save "ä¿å­˜å¹¶å…³é—­" width:120 height:28 across:2
        button btn_cancel "å–æ¶ˆ" width:120 height:28
    )
    
    -- ===== ç•Œé¢æ›´æ–°å‡½æ•°ï¼ˆä¼˜åŒ–ç‰ˆï¼‰=====
    
    fn updateUI = 
    (
        -- æ›´æ–°è¿‡æ»¤åˆ—è¡¨æ˜¾ç¤º
        if LcL_FilterSettings != undefined and LcL_FilterSettings.count > 0 then
            lst_filters.items = LcL_FilterSettings
        else
            lst_filters.items = #()
        
        -- æ›´æ–°å¯¼å‡ºè®¾ç½®æ˜¾ç¤º
        if LcL_ExportSettings != undefined then
        (
            chk_animation.checked = LcL_ExportSettings.includeAnimation
            rad_fileFormat.state = if LcL_ExportSettings.fileFormat == "Binary" then 1 else 2
            rad_unit.state = if LcL_ExportSettings.convertUnit == "cm" then 1 else 2
            rad_upAxis.state = if LcL_ExportSettings.upAxis == "Y" then 1 else 2
        )
        
        
        -- æ›´æ–°çŠ¶æ€ä¿¡æ¯
        local filterCount = if LcL_FilterSettings != undefined then LcL_FilterSettings.count else 0
        lbl_status.text = "å½“å‰æœ‰ " + filterCount as string + " ä¸ªè¿‡æ»¤è§„åˆ™"
    )
    
    fn updateSettingsFromUI = 
    (
        if LcL_ExportSettings != undefined then
        (
            LcL_ExportSettings.includeAnimation = chk_animation.checked
            LcL_ExportSettings.fileFormat = if rad_fileFormat.state == 1 then "Binary" else "ASCII"
            LcL_ExportSettings.convertUnit = if rad_unit.state == 1 then "cm" else "m"
            LcL_ExportSettings.upAxis = if rad_upAxis.state == 1 then "Y" else "Z"
            LcL_ExportSettings.bakeAnimation = chk_animation.checked
        )
        
    )
    
    -- ===== äº‹ä»¶å¤„ç†ï¼ˆä¼˜åŒ–ç‰ˆï¼‰=====
    
    on LcL_SettingsRollout open do
    (
        -- ç¡®ä¿å…¨å±€å˜é‡åˆå§‹åŒ–
        if LcL_FilterSettings == undefined or LcL_FilterSettings.count == 0 then
            global LcL_FilterSettings = #("Camera", "pickshape")
        if LcL_ExportSettings == undefined then
            global LcL_ExportSettings = LcL_ExportConfig()
        if LcL_ColorSettings == undefined then
            global LcL_ColorSettings = LcL_ColorConfig()
        
        updateUI()
        format "è®¾ç½®ç•Œé¢å·²æ‰“å¼€\n"
    )
    
    -- å¯¼å‡ºè®¾ç½®å®æ—¶æ›´æ–°
    on chk_animation changed state do updateSettingsFromUI()
    on rad_fileFormat changed state do updateSettingsFromUI()
    on rad_unit changed state do updateSettingsFromUI()
    on rad_upAxis changed state do updateSettingsFromUI()
    
    
    -- è¿‡æ»¤è¯ç®¡ç†
    on btn_addFilter pressed do
    (
        local newFilter = trimLeft (trimRight edt_newFilter.text)
        if newFilter != "" then
        (
            if findItem LcL_FilterSettings newFilter == 0 then
            (
                append LcL_FilterSettings newFilter
                edt_newFilter.text = ""
                updateUI()
                lbl_status.text = "å·²æ·»åŠ : " + newFilter
            )
            else
            (
                lbl_status.text = "è¿‡æ»¤è¯å·²å­˜åœ¨: " + newFilter
            )
        )
        else
        (
            lbl_status.text = "è¯·è¾“å…¥è¿‡æ»¤å…³é”®è¯"
        )
    )
    
    -- å›è½¦å¿«é€Ÿæ·»åŠ 
    on edt_newFilter entered text do
    (
        local newFilter = trimLeft (trimRight text)
        if newFilter != "" and findItem LcL_FilterSettings newFilter == 0 then
        (
            append LcL_FilterSettings newFilter
            edt_newFilter.text = ""
            updateUI()
            lbl_status.text = "å·²æ·»åŠ : " + newFilter
        )
    )
    
    -- åˆ é™¤é€‰ä¸­é¡¹
    on btn_removeFilter pressed do
    (
        if lst_filters.selection > 0 then
        (
            local removedFilter = LcL_FilterSettings[lst_filters.selection]
            deleteItem LcL_FilterSettings lst_filters.selection
            updateUI()
            lbl_status.text = "å·²åˆ é™¤: " + removedFilter
        )
        else
        (
            lbl_status.text = "è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¡¹ç›®"
        )
    )
    
    -- æ¸…ç©ºæ‰€æœ‰
    on btn_clear pressed do
    (
        if queryBox "ç¡®å®šæ¸…ç©ºæ‰€æœ‰è¿‡æ»¤è®¾ç½®ï¼Ÿ" title:"ç¡®è®¤" then
        (
            LcL_FilterSettings = #()
            updateUI()
            lbl_status.text = "å·²æ¸…ç©ºæ‰€æœ‰è¿‡æ»¤è§„åˆ™"
        )
    )
    
    -- é‡ç½®é»˜è®¤
    on btn_reset pressed do
    (
        if queryBox "é‡ç½®ä¸ºé»˜è®¤è¿‡æ»¤è®¾ç½®ï¼Ÿ" title:"ç¡®è®¤" then
        (
            LcL_FilterSettings = #("Camera", "pickshape")
            updateUI()
            lbl_status.text = "å·²é‡ç½®ä¸ºé»˜è®¤è®¾ç½®"
        )
    )
    
    -- ä¿å­˜å¹¶å…³é—­
    on btn_save pressed do
    (
        updateSettingsFromUI()
        LcL_SaveSettings()
        lbl_status.text = "è®¾ç½®å·²ä¿å­˜"
        LcL_CloseSettingsDialog()
    )
    
    -- å–æ¶ˆ
    on btn_cancel pressed do
    (
        LcL_CloseSettingsDialog()
    )
)

-- æ˜¾ç¤ºè®¾ç½®å¯¹è¯æ¡†
fn LcL_ShowSettingsDialog = 
(
    -- ç¡®ä¿å…¨å±€å˜é‡å·²å®šä¹‰
    if LcL_FilterSettings == undefined then
        global LcL_FilterSettings = #("Camera", "pickshape")
    if LcL_ColorSettings == undefined then
    (
        global LcL_ColorSettings = LcL_ColorConfig()
        global LcL_VertexIndexColor = LcL_ColorSettings.vertexIndexColor
        global LcL_FaceIndexColor = LcL_ColorSettings.faceIndexColor
    )
    
    -- å¦‚æœå¯¹è¯æ¡†å·²å­˜åœ¨ï¼Œå…³é—­å®ƒ
    if LcL_SettingsDialog != undefined then
    (
        -- æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„å¯¹è¯æ¡†å¯¹è±¡
        if (isKindOf LcL_SettingsDialog RolloutFloater) or (isKindOf LcL_SettingsDialog DialogBox) then
            destroyDialog LcL_SettingsDialog
        else
            format "âš  æ¸…ç†æ— æ•ˆçš„å¯¹è¯æ¡†çŠ¶æ€\n"
            
        LcL_SettingsDialog = undefined
    )
    
    -- åˆ›å»ºæ–°å¯¹è¯æ¡†
    LcL_SettingsDialog = createDialog LcL_SettingsRollout modal:false
    format "âœ… LcL Toolsè®¾ç½®ç•Œé¢å·²æ‰“å¼€\n"
)

-- å…³é—­è®¾ç½®å¯¹è¯æ¡†
fn LcL_CloseSettingsDialog = 
(
    if LcL_SettingsDialog != undefined then
    (
        -- æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„å¯¹è¯æ¡†å¯¹è±¡
        if (isKindOf LcL_SettingsDialog RolloutFloater) or (isKindOf LcL_SettingsDialog DialogBox) then
        (
            destroyDialog LcL_SettingsDialog
            format "âœ… LcL Toolsè®¾ç½®ç•Œé¢å·²å…³é—­\n"
        )
        else
        (
            format "âš  æ¸…ç†æ— æ•ˆçš„å¯¹è¯æ¡†çŠ¶æ€\n"
        )
        
        LcL_SettingsDialog = undefined
    )
)

-- åˆå§‹åŒ–è®¾ç½®
LcL_LoadSettings()

-- åŒæ­¥é¢œè‰²è®¾ç½®åˆ°ç´¢å¼•æ˜¾ç¤ºæ¨¡å—
if LcL_ColorSettings != undefined then
(
    if LcL_VertexIndexColor == undefined then global LcL_VertexIndexColor = LcL_ColorSettings.vertexIndexColor
    if LcL_FaceIndexColor == undefined then global LcL_FaceIndexColor = LcL_ColorSettings.faceIndexColor
    global LcL_VertexIndexColor = LcL_ColorSettings.vertexIndexColor
    global LcL_FaceIndexColor = LcL_ColorSettings.faceIndexColor
)

format "âœ… LcL Tools è®¾ç½®åŠŸèƒ½åŠ è½½å®Œæˆ\n"
